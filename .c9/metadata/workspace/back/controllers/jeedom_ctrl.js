{"filter":false,"title":"jeedom_ctrl.js","tooltip":"/back/controllers/jeedom_ctrl.js","undoManager":{"mark":11,"position":11,"stack":[[{"group":"doc","deltas":[{"start":{"row":202,"column":0},"end":{"row":203,"column":0},"action":"remove","lines":["        }",""]}]}],[{"group":"doc","deltas":[{"start":{"row":164,"column":0},"end":{"row":191,"column":0},"action":"remove","lines":["        if (err) {","            console.error(err);","        }","","        var commandLine=\"\";","        var commandCode = translateCommand(command,device.type,iterate);","        if (device.protocol==\"dio\") {","          commandLine = 'sudo '+'send-'+device.protocol+' 0 '+remoteDio+' '+device.publicId+' '+commandCode;","        }","        if (device.protocol==\"rf433\") {","          //commandLine = 'sudo '+'send-'+device.protocol+' 0 '+homeCodeRF433+' '+device.publicId+' '+commandCode;","          commandLine = 'sudo '+'send-'+device.protocol+' 0 '+device.publicId+' '+commandCode;","        }","        if (device.protocol==\"ir\") {","          //Yamaha_RAV302","          commandLine = 'irsend SEND_ONCE '+device.publicId+' '+commandCode;","        }","","        if (commandLine!==\"\") {","            console.log(commandLine);","            exec(commandLine, function (error, stdout, stderr) {","              if(err) console.error(err);","                  if (callback) callback();","              });","        }","        ","        if (url!==\"\") {",""]}]}],[{"group":"doc","deltas":[{"start":{"row":162,"column":0},"end":{"row":164,"column":0},"action":"remove","lines":["    var cb = function (err, device) {","",""]}]}],[{"group":"doc","deltas":[{"start":{"row":173,"column":0},"end":{"row":176,"column":0},"action":"remove","lines":["    }","","    Devices.findByCode(code,cb);",""]}]}],[{"group":"doc","deltas":[{"start":{"row":162,"column":0},"end":{"row":162,"column":4},"action":"remove","lines":["    "]},{"start":{"row":163,"column":0},"end":{"row":163,"column":4},"action":"remove","lines":["    "]},{"start":{"row":164,"column":0},"end":{"row":164,"column":4},"action":"remove","lines":["    "]},{"start":{"row":165,"column":0},"end":{"row":165,"column":4},"action":"remove","lines":["    "]},{"start":{"row":166,"column":0},"end":{"row":166,"column":4},"action":"remove","lines":["    "]},{"start":{"row":167,"column":0},"end":{"row":167,"column":4},"action":"remove","lines":["    "]},{"start":{"row":168,"column":0},"end":{"row":168,"column":4},"action":"remove","lines":["    "]},{"start":{"row":169,"column":0},"end":{"row":169,"column":4},"action":"remove","lines":["    "]},{"start":{"row":170,"column":0},"end":{"row":170,"column":4},"action":"remove","lines":["    "]},{"start":{"row":171,"column":0},"end":{"row":171,"column":4},"action":"remove","lines":["    "]},{"start":{"row":172,"column":0},"end":{"row":172,"column":4},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":162,"column":0},"end":{"row":162,"column":4},"action":"remove","lines":["    "]},{"start":{"row":163,"column":0},"end":{"row":163,"column":4},"action":"remove","lines":["    "]},{"start":{"row":164,"column":0},"end":{"row":164,"column":4},"action":"remove","lines":["    "]},{"start":{"row":165,"column":0},"end":{"row":165,"column":4},"action":"remove","lines":["    "]},{"start":{"row":166,"column":0},"end":{"row":166,"column":4},"action":"remove","lines":["    "]},{"start":{"row":167,"column":0},"end":{"row":167,"column":4},"action":"remove","lines":["    "]},{"start":{"row":168,"column":0},"end":{"row":168,"column":4},"action":"remove","lines":["    "]},{"start":{"row":169,"column":0},"end":{"row":169,"column":4},"action":"remove","lines":["    "]},{"start":{"row":170,"column":0},"end":{"row":170,"column":4},"action":"remove","lines":["    "]},{"start":{"row":171,"column":0},"end":{"row":171,"column":4},"action":"remove","lines":["    "]},{"start":{"row":172,"column":0},"end":{"row":172,"column":4},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":154,"column":0},"end":{"row":159,"column":0},"action":"remove","lines":["function wait(cb) {","    console.log(\"waiting\");","    sleep.usleep(500000);","    if (cb) cb();","}",""]}]}],[{"group":"doc","deltas":[{"start":{"row":9,"column":0},"end":{"row":154,"column":0},"action":"remove","lines":["","var exec = require('child_process').exec;","","exports.listDevices = function (req, res) {","    console.log(\"Controller - findAll\");","    Devices.findAll(function (err, devices) {","","        if (err) {","            res.send(\"ERROR\")","        }","        res.send(devices);","","    });","};","","exports.listScenarios = function (req, res) {","    Scenarios.findAll(function (err, scenarios) {","","        if (err) {","            res.send(\"ERROR\")","        }","        res.send(scenarios);","","    });","};","","","exports.deviceFindByCode = function (req, res) {","","    var code = req.params.code;","","    console.log(\"Controller - findByCode : \"+code);","","    Devices.findByCode(code, function (err, device) {","","        if (err) {","            res.send(\"ERROR\")","        }","        res.send(device);","    });","};","","","exports.deviceCommand = function(req, res){","    var code = req.params.code;","    var command = req.params.command;","    var iterate = req.params.iterate;","","    runDeviceCommand(res,code,command,\"\",iterate,function() {","        res.send(\"OK\");","    });","","};","","exports.deviceCommandOne = function(req, res){","    var code = req.params.code;","    var command = req.params.command;","    var iterate = 1;","","    runDeviceCommand(res,code,command,\"\",iterate,function() {","        res.send(\"OK\");","    });","","};","","exports.scenarioCommand = function(req, res){","    var code = req.params.code;","    var command = req.params.command;","","    var cb = function (res) {","        res.send(\"OK\");","    };",""," ","    console.log(\"getScenario code=\"+code+ \",command=\"+command);","    Scenarios.getScenario(code, function (err, scenario) {","        ","        for (var a = 0; a < scenario.actions.length; a++) {","            if (scenario.actions[a].code===command) {","                async.eachSeries(scenario.actions[a].comands, function(item,callback) {","                        wait(runDeviceCommand(res,item.device.code, item.control.code, item.control.url,1,function() { ","                            callback();","                        }));","                });","            }","        }","    });","    ","    cb(res);","","};","","function translateCommand(word,type,iterate){","    var it = Math.abs(parseInt(iterate));","    if (type==\"AMPLIFIER\") {","        switch (word) {","            case \"on\":","                return \"SYSTEM_POWER\";","            case \"off\":","                return \"STANDBY\";","            case \"mute\":","                return \"MUTE\";","            case \"vol\":","                var v=\"\";","                var i;","                for (i=0; i < it; i++) {","                    if (iterate.charAt(0) == \"-\")","                      v = v + \"VOL- \";","                    else","                      v = v + \"VOL+ \";","                }","                return v;","            case \"modetv\":","                return \"DTV/CBL\";","            case \"modemovie\":","                return \"DVD\";","            default :","                return \"-1\";","        }","    }","    if ((type==\"SOCKET\") || (type==\"SHUTTER\")) {","        switch (word) {","            case \"on\":","            case \"up\":","                return \"1\";","            case \"off\":","            case \"down\":","                return \"0\";","            default :","                return \"-1\";","        }","    }","}","","function translateStatus(word){","    switch (word) {","        case \"on\":","            return 1;","        case \"off\":","            return 0;","        default :","            return -1;","    }","}","",""]}]}],[{"group":"doc","deltas":[{"start":{"row":5,"column":0},"end":{"row":7,"column":0},"action":"remove","lines":["var sleep  = require('sleep');","var async = require('async');",""]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":3,"column":0},"action":"remove","lines":["var Devices = require('../models/devices');","var Categories = require('../models/category');","var Scenarios = require('../models/scenarios');",""]}]}],[{"group":"doc","deltas":[{"start":{"row":1,"column":0},"end":{"row":2,"column":0},"action":"remove","lines":["//var homeCodeRF433 = process.env.HOMECODERF433;",""]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":0,"column":38},"action":"remove","lines":["var remoteDio = process.env.REMOTEDIO;"]},{"start":{"row":0,"column":0},"end":{"row":0,"column":38},"action":"insert","lines":["var jeedomApikey = process.env.APIKEY;"]}]}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":0,"column":38},"end":{"row":0,"column":38},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1428252819664,"hash":"a37b8745f8112ae5cae03e1ce222a32ccf66c214"}